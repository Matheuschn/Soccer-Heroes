<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Soccer Heroes</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <script src="js/phaser-matter-collision-plugin.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var config = {
    type: Phaser.AUTO,
    width: 800,
    height: 600,
    physics: {
        default: 'matter',
        matter: {
            debug: true
        }
    },
    plugins: {
        scene: [
            {
                plugin: PhaserMatterCollisionPlugin, // The plugin class
                key: "matterCollision", // Where to store in Scene.Systems, e.g. scene.sys.matterCollision
                mapping: "matterCollision" // Where to store in the Scene, e.g. scene.matterCollision
            }
        ]
    },
    scene: {
        preload: preload,
        create: create,
        update: update
    }
};

var Body;
var ground;
var playerLeft;
var playerLeftLeftFoot;
var playerLeftRightFoot;
var playerLeftFoot;
var playerRight;
var playerRightFoot;
var ball;
var cursors;
var scoreLeft = 0;
var scoreRight = 0;
var scoreText;
var goals;
var posts;
var WKey;
var AKey;
var DKey;
var SpaceKey;
var EnterKey;
var test;

var game = new Phaser.Game(config);

function preload ()
{
    this.load.image('sky', 'assets/sky.png');
    this.load.image('ground', 'assets/ground.png');
    this.load.image('ball', 'assets/ball.png');
    this.load.spritesheet('player', 'assets/player.png', { frameWidth: 32, frameHeight: 48 });
    this.load.image('goal', 'assets/goal.png');
   //this.load.image('post', 'assets/post.png');
}

function create ()
{
    Body = Phaser.Physics.Matter.Matter.Body;

    this.add.image(0, 0, 'sky').setOrigin(0,0);
    this.matter.world.setBounds(0, 0, game.config.width, game.config.height);

    ground = this.matter.add.image(0, 600, 'ground')
        .setScale(4)
        .setStatic(true);

    scoreText = this.add.text(350, 16, '0 - 0', { fontSize: '32px', fill: '#000' });

    cursors = this.input.keyboard.createCursorKeys();
    WKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.W);
    AKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.A);
    DKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.D);
    RKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.R);
    SpaceKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);
    EnterKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.ENTER);

    groundCollision = 0x0001;
    playerCollision = 0x0004;
    ballCollision = 0x0008;
    goalLeftCollision = 0x0016;
    goalRightCollision = 0x0032;

    var playerLeftBody = Phaser.Physics.Matter.Matter.Bodies.rectangle(100, 400, 32, 48, { chamfer: { radius: 10 } });
    playerLeftLeftFoot = this.matter.add.rectangle(100, 400, 30, 12, { chamfer: { radius: 5 } });
    playerLeftRightFoot = this.matter.add.rectangle(100, 400, 30, 12, { chamfer: { radius: 5 } });
    playerLeftFoot = "right";
    playerLeft = this.matter.add.sprite(100, 512, 'player')
        .setExistingBody(playerLeftBody)
        .setFixedRotation(0)
        .setMass(100)
        .setCollisionCategory(playerCollision)
        .setCollidesWith([
            groundCollision,
            playerCollision,
            ballCollision
    ]);
    this.matter.add.constraint(playerLeft, playerLeftLeftFoot, 0, 0.5, { pointA: { x: -16, y: 24 }, pointB: { x: -15, y: 0 }});
    this.matter.add.constraint(playerLeft, playerLeftRightFoot, 0, 0.5, { pointA: { x: 16, y: 24 }, pointB: { x: -15, y: 0 }});

    playerRight = this.matter.add.sprite(700, 512, 'player')    
        .setFixedRotation(0)
        .setMass(100)
        .setCollisionCategory(playerCollision)
        .setCollidesWith([
            groundCollision,
            playerCollision,
            ballCollision
    ]);
    playerRightFoot = this.matter.add.rectangle(100, 400, 30, 12, {
            chamfer: {radius: 5}
    });
    this.matter.add.constraint(playerRight, playerRightFoot, 0, 0.5, { pointA: { x: 16, y: 24 }, pointB: { x: -15, y: 0 }});

    this.anims.create({
        key: 'left',
        frames: this.anims.generateFrameNumbers('player', { start: 0, end: 3 }),
        frameRate: 10,
        repeat: -1
    });

    this.anims.create({
        key: 'turn',
        frames: [ { key: 'player', frame: 4 } ],
        frameRate: 20
    });

    this.anims.create({
        key: 'right',
        frames: this.anims.generateFrameNumbers('player', { start: 5, end: 8 }),
        frameRate: 10,
        repeat: -1
    });

    ball = this.matter.add.sprite(400, 400, 'ball')
        .setMass(5)
        .setCircle(7)
        .setScale(2)
        .setBounce(1)
        .setCollisionCategory(ballCollision)
        .setCollidesWith([
            groundCollision, 
            playerCollision
        ]);
    
    
    goalLeft = this.matter.add.rectangle(23, 488, 45, 96, { isSensor: true, isStatic: true });
    this.add.image(0, 440, 'goal').setOrigin(0,0);

    goalRight = this.matter.add.rectangle(777, 488, 45, 96, { isSensor: true, isStatic: true });
    this.add.image(800, 440, 'goal').setOrigin(0,0).setScale(-1, 1);

   // postLeft = this.matter.add.rectangle(23, 440, 45, 3, { isStatic: true });
    //postRight = this.matter.add.rectangle(777, 440, 45, 3, { isStatic: true });
}

function update ()
{
    playerRightControls.call(this);
    playerLeftControls.call(this);
    checkGoal.call(this);

    if(RKey.isDown)
    {
        resetMatch();
    }
}

function playerRightControls ()
{
    Body.setAngularVelocity(playerRightFoot, 0);
    Body.setAngle(playerRightFoot, Math.PI / 2);

    if (cursors.left.isDown)
    {
        playerRight.setVelocityX(-3);

        playerRight.anims.play('left', true);
    }
    else if (cursors.right.isDown)
    {
        playerRight.setVelocityX(3);

        playerRight.anims.play('right', true);
    }
    else
    {
        playerRight.setVelocityX(0);

        playerRight.anims.play('turn');
    }

    if (EnterKey.isDown)
    {
        playerRightFoot.collisionFilter.mask = 0x0008;
        Body.setAngle(playerRightFoot, 5.49);
    }
    else
    {
        playerRightFoot.collisionFilter.mask = 0x0001;
    }

    this.matterCollision.addOnCollideActive({
        objectA: playerRight,
        objectB: ground,
        callback: () => 
        {
            if (cursors.up.isDown)
            {
                playerRight.setVelocityY(-7);
            }
        }
    });
}

function playerLeftControls ()
{
    Body.setAngularVelocity(playerLeftLeftFoot, 0);
    Body.setAngle(playerLeftLeftFoot, Math.PI / 2);

    Body.setAngularVelocity(playerLeftRightFoot, 0);
    Body.setAngle(playerLeftRightFoot, Math.PI / 2);

    if (AKey.isDown)
    {
        playerLeft.setVelocityX(-3);
        playerLeftFoot = "left";
        playerLeft.anims.play('left', true);
    }
    else if (DKey.isDown)
    {
        playerLeft.setVelocityX(3);
        playerLeftFoot = "right";
        playerLeft.anims.play('right', true);
    }
    else
    {
        playerLeft.setVelocityX(0);

        playerLeft.anims.play('turn');
    }

    if (SpaceKey.isDown && playerLeftFoot === "right")
    {
        playerLeftRightFoot.collisionFilter.mask = 0x0008;
        Body.setAngle(playerLeftRightFoot, 5.49);
    }
    else if (SpaceKey.isDown && playerLeftFoot === "left")
    {
        playerLeftLeftFoot.collisionFilter.mask = 0x0008;
        Body.setAngle(playerLeftLeftFoot, 3.92);
    }
    else
    {
        playerLeftLeftFoot.collisionFilter.mask = 0x0001;
        playerLeftRightFoot.collisionFilter.mask = 0x0001;
    }

    this.matterCollision.addOnCollideActive({
        objectA: playerLeft,
        objectB: ground,
        callback: () => 
        {
            if (WKey.isDown)
            {
                playerLeft.setVelocityY(-7);
            }
        }
    });
}

function checkGoal()
{
    this.matterCollision.addOnCollideActive({
        objectA: goalLeft,
        objectB: ball,
        callback: () => 
        {
            if (ball.x <= 31 && ball.y >= 443)
            {
                scoreRight++;
                scoreText.setText(scoreLeft + " - " + scoreRight);
                resetMatch();
            }
        }
    });
    this.matterCollision.addOnCollideActive({
        objectA: goalRight,
        objectB: ball,
        callback: () => 
        {
            if (ball.x >= 769 && ball.y >= 443)
            {
                scoreLeft++;
                scoreText.setText(scoreLeft + " - " + scoreRight);
                resetMatch();
            }
        }
    });
}

function resetMatch()
{
    playerLeft.setPosition(100, 512)
              .setVelocity(0,0);
    playerRight.setPosition(700, 512)
               .setVelocity(0,0);
    ball.setPosition(400, 522)
        .setVelocity(0,0)
        .setRotation(0);
}

</script>

</body>
</html>
