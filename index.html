<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Soccer Heroes</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <script src="js/phaser-matter-collision-plugin.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var config = {
    type: Phaser.AUTO,
    width: 800,
    height: 600,
    physics: {
        default: 'matter',
        matter: {
            debug: true
        }
    },
    plugins: {
        scene: [
            {
                plugin: PhaserMatterCollisionPlugin, // The plugin class
                key: "matterCollision", // Where to store in Scene.Systems, e.g. scene.sys.matterCollision
                mapping: "matterCollision" // Where to store in the Scene, e.g. scene.matterCollision
            }
        ]
    },
    scene: {
        preload: preload,
        create: create,
        update: update
    }
};

var ground;
var playerLeft;
var playerRight;
var ball;
var cursors;
var scoreLeft = 0;
var scoreRight = 0;
var scoreText;
var goals;
var posts;
var WKey;
var AKey;
var DKey;

var game = new Phaser.Game(config);

function preload ()
{
    this.load.image('sky', 'assets/sky.png');
    this.load.image('ground', 'assets/ground.png');
    this.load.image('ball', 'assets/ball.png');
    this.load.spritesheet('player', 'assets/player.png', { frameWidth: 32, frameHeight: 48 });
    this.load.image('goal', 'assets/goal.png');
    this.load.image('post', 'assets/post.png');
}

function create ()
{
    this.add.image(0, 0, 'sky').setOrigin(0,0);
    this.matter.world.setBounds(0, 0, game.config.width, game.config.height);

    ground = this.matter.add.image(0, 600, 'ground')
        .setScale(4)
        .setStatic(true);

    scoreText = this.add.text(350, 16, '0 - 0', { fontSize: '32px', fill: '#000' });

    cursors = this.input.keyboard.createCursorKeys();
    WKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.W);
    AKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.A);
    DKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.D);
    RKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.R);

    groundCollision = 0x0001;
    playerCollision = 0x0004;
    ballCollision = 0x0008;
    goalLeftCollision = 0x0010;
    goalRightCollision = 0x0012;

    playerLeft = this.matter.add.sprite(100, 512, 'player')
        .setFixedRotation(0)
        .setMass(100)
        .setCollisionCategory(playerCollision)
        .setCollidesWith([
            groundCollision,
            playerCollision,
            ballCollision
        ]);
    var playerLeftFoot = this.matter.add.rectangle(100, 400, 30, 15, {
            chamfer: {radius: 5}
        });
    /*var playerLeftHinge = Phaser.Physics.Matter.Matter.Constraint.create({
            bodyA: playerLeft,
            bodyB: playerLeftHinge,
            pointA: { x: 16, y: -24 },
            length: 0,
            stiffness: 1
        });
    */
    this.matter.add.constraint(playerLeft, playerLeftFoot, 0, 1, { pointA: { x: 16, y: 24}, pointB: { x: 0, y: 15}});
    
    playerRight = this.matter.add.sprite(700, 512, 'player')    
        .setFixedRotation(0)
        .setMass(100)
        .setCollisionCategory(playerCollision)
        .setCollidesWith([
            groundCollision,
            playerCollision,
            ballCollision
        ]);

    this.anims.create({
        key: 'left',
        frames: this.anims.generateFrameNumbers('player', { start: 0, end: 3 }),
        frameRate: 10,
        repeat: -1
    });

    this.anims.create({
        key: 'turn',
        frames: [ { key: 'player', frame: 4 } ],
        frameRate: 20
    });

    this.anims.create({
        key: 'right',
        frames: this.anims.generateFrameNumbers('player', { start: 5, end: 8 }),
        frameRate: 10,
        repeat: -1
    });

    ball = this.matter.add.sprite(400, 400, 'ball')
        .setMass(0.5)
        .setCircle(7)
        .setScale(2)
        .setBounce(1)
        .setCollisionCategory(ballCollision)
        .setCollidesWith([
            groundCollision, 
            playerCollision
        ]);
    
    goalLeft = this.matter.add.rectangle(23, 488, 45, 96, { isSensor: true, isStatic: true });
    this.add.image(0, 440, 'goal').setOrigin(0,0);

    goalRight = this.matter.add.rectangle(777, 488, 45, 96, { isSensor: true, isStatic: true });
    this.add.image(800, 440, 'goal').setOrigin(0,0).setScale(-1, 1);

    postLeft = this.matter.add.rectangle(23, 440, 45, 3, { isStatic: true });
    postRight = this.matter.add.rectangle(777, 440, 45, 3, { isStatic: true });
}

function update ()
{
    playerRightControls.call(this);
    playerLeftControls.call(this);
    checkGoal.call(this);

    if(RKey.isDown)
    {
        resetMatch();
    }
}

function playerRightControls ()
{
    if (cursors.left.isDown)
    {
        playerRight.setVelocityX(-5);

        playerRight.anims.play('left', true);
    }
    else if (cursors.right.isDown)
    {
        playerRight.setVelocityX(5);

        playerRight.anims.play('right', true);
    }
    else
    {
        playerRight.setVelocityX(0);

        playerRight.anims.play('turn');
    }

    this.matterCollision.addOnCollideActive({
        objectA: playerRight,
        objectB: ground,
        callback: () => 
        {
            if (cursors.up.isDown)
            {
                playerRight.setVelocityY(-7);
            }
        }
    });
}

function playerLeftControls ()
{
    if (AKey.isDown)
    {
        playerLeft.setVelocityX(-5);

        playerLeft.anims.play('left', true);
    }
    else if (DKey.isDown)
    {
        playerLeft.setVelocityX(5);

        playerLeft.anims.play('right', true);
    }
    else
    {
        playerLeft.setVelocityX(0);

        playerLeft.anims.play('turn');
    }

    this.matterCollision.addOnCollideActive({
        objectA: playerLeft,
        objectB: ground,
        callback: () => 
        {
            if (WKey.isDown)
            {
                playerLeft.setVelocityY(-7);
            }
        }
    });
}

function checkGoal()
{
    this.matterCollision.addOnCollideActive({
        objectA: goalLeft,
        objectB: ball,
        callback: () => 
        {
            if (ball.x <= 31 && ball.y >= 443)
            {
                scoreRight++;
                scoreText.setText(scoreLeft + " - " + scoreRight);
                resetMatch();
            }
        }
    });
    this.matterCollision.addOnCollideActive({
        objectA: goalRight,
        objectB: ball,
        callback: () => 
        {
            if (ball.x >= 769 && ball.y >= 443)
            {
                scoreLeft++;
                scoreText.setText(scoreLeft + " - " + scoreRight);
                resetMatch();
            }
        }
    });
}

function resetMatch()
{
    playerLeft.setPosition(100, 512)
              .setVelocity(0,0);
    playerRight.setPosition(700, 512)
               .setVelocity(0,0);
    ball.setPosition(400, 522)
        .setVelocity(0,0)
        .setRotation(0);
}

</script>

</body>
</html>